name: Linux Remote Desktop - Fixed GUI

on:
  workflow_dispatch:
    inputs:
      auth_code:
        description: 'الأمر الذي يبدأ بـ DISPLAY= (يجب أن يكون جديداً)'
        required: true
      pin_code:
        description: 'الرمز السري (PIN) المكون من 6 أرقام'
        required: true
        default: '123456'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: تثبيت الواجهة الرسومية والأدوات الأساسية
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y xfce4 xfce4-goodies x11-xserver-utils desktop-base dbus-x11 xserver-xorg-video-dummy wget

      - name: تثبيت Chrome Remote Desktop
        run: |
          wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y ./chrome-remote-desktop_current_amd64.deb

      - name: إعداد المستخدم وحل مشكلة الـ Failsafe Session
        run: |
          sudo useradd -m user
          sudo adduser user sudo
          echo "user:${{ github.event.inputs.pin_code }}" | sudo chpasswd
          echo "user ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/user
          
          # إعداد الجلسة الرسومية بشكل صحيح لتجنب خطأ الصورة الأخيرة
          sudo -u user bash -c 'echo "exec startxfce4" > ~/.chrome-remote-desktop-session'
          sudo -u user bash -c 'mkdir -p ~/.config/xfce4'
          
          # تأكيد الصلاحيات
          sudo chown user:user /home/user/.chrome-remote-desktop-session

      - name: تشغيل الخدمة والاتصال
        run: |
          # التشغيل باستخدام كود المصادقة الجديد
          sudo -u user -i bash -c "${{ github.event.inputs.auth_code }} --pin=${{ github.event.inputs.pin_code }}" &
          
          echo "--- السيرفر جاهز! اذهب الآن لمتصفحك ---"
          
          # إبقاء الجلسة تعمل لمدة 6 ساعات
          sleep 21600
